#!/usr/sbin/nft -f

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority filter; policy drop;

    # Loopback
    iifname "lo" accept

    # Permite conexiones establecidas
    ct state established,related accept

    # SSH desde LAN
    iifname "ens19" tcp dport 22 accept

    # WireGuard: tráfico VPN entre sedes
    iifname "wg0" accept

    # WireGuard: tráfico VPN con el portatil del jefe
    iifname "wg1" accept

    # WireGuard en WAN (intrasedes y portatil)
    iifname "ens18" udp dport {51820, 51821} accept

    # ICMP (diagnóstico)
    ip protocol icmp accept

    # Registro por defecto
    log prefix "NF_INPUT_DROP: " group 0
  }

  chain forward {
    type filter hook forward priority filter; policy drop;

    # Permite conexiones establecidas
    ct state established,related accept

    # Salida a Internet desde LAN/DMZ
    iifname "ens19" oifname "ens18" accept
    iifname "ens20" oifname "ens18" accept

    # Publicación web: tras DNAT permitir WAN->DMZ
    iifname "ens18" oifname "ens20" tcp dport {80,443} ct state new accept

    # Paso entre sedes por WireGuard (bidireccional)
    iifname {"wg0", "wg1"} oifname { "ens19", "ens20" } accept
    iifname { "ens19", "ens20" } oifname {"wg0", "wg1"} accept

    # Acceso remoto (wg1) a la otra sede a través de wg0
    iifname "wg1" oifname "wg0" accept
    iifname "wg0" oifname "wg1" accept

    # DMZ -> LAN: solo servicios del DC, BBDD y Nextcloud
    iifname "ens20" oifname "ens19" ip daddr 10.0.2.21 tcp dport {636,53} ct state new accept
    iifname "ens20" oifname "ens19" ip daddr 10.0.2.22 tcp dport {3306,5432} ct state new accept
    iifname "ens20" oifname "ens19" ip daddr 10.0.2.21 udp dport 53 ct state new accept
    iifname "ens20" oifname "ens19" ip daddr 10.0.2.23 tcp dport 80 ct state new accept

    # LAN -> DMZ: web e ICMP hacia host publicado; SSH desde DC
    iifname "ens19" oifname "ens20" ip saddr 10.0.2.0/24 ip daddr 10.0.3.10 tcp dport {80,443} accept
    iifname "ens19" oifname "ens20" ip saddr 10.0.2.0/24 ip daddr 10.0.3.10 icmp type echo-request accept
    iifname "ens19" oifname "ens20" ip saddr 10.0.2.21 ip daddr 10.0.3.10 tcp dport 22 ct state new accept

    # Replicación DC Coruña en DC Orense
    tcp dport 49152-65535 ip saddr 10.0.2.21 ip daddr 10.0.4.21 accept
    tcp sport 49152-65535 ip saddr 10.0.4.21 ip daddr 10.0.2.21 accept
  }

  chain output {
    type filter hook output priority filter; policy accept;
  }
}

table ip nat {
  # Redes internas/VPN que no deben pasar por NAT
  set redes_vpn {
    type ipv4_addr; flags interval
    elements = { 10.0.2.0/24, 10.0.3.0/24, 10.0.4.0/24, 10.0.5.0/24, 10.99.0.0/30, 10.99.10.0/24 }
  }

  chain prerouting {
    type nat hook prerouting priority dstnat; policy accept;

    # Publicación web en DMZ lo dejo preparado aunque no implemente https puerto 443
    iifname "ens18" tcp dport 80 dnat to 10.0.3.10:80
    iifname "ens18" tcp dport 443 dnat to 10.0.3.10:443
  }

  chain postrouting {
    type nat hook postrouting priority srcnat; policy accept;

    # No NAT hacia redes internas/VPN
    ip daddr @redes_vpn return

    # NAT a Internet por WAN
    oifname "ens18" masquerade
  }
}
