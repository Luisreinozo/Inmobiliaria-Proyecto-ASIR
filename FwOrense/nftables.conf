#!/usr/sbin/nft -f
flush ruleset

table inet filter {
  chain input {
    type filter hook input priority filter; policy drop;

    # Permite tráfico loopback
    iifname "lo" accept

    # Permite conexiones establecidas
    ct state established,related accept

    # SSH desde LAN
    iifname "ens19" tcp dport 22 accept

    # WireGuard en WAN (tráfico al propio firewall)
    iifname "ens18" udp dport 51820 accept
    iifname "wg0" accept

    # ICMP diagnóstico
    ip protocol icmp accept

    log prefix "ORENSE_INPUT_DROP: " group 0
  }

  chain forward {
    type filter hook forward priority filter; policy drop;

    # Permite conexiones establecidas
    ct state established,related accept

    # LAN -> Internet
    iifname "ens19" oifname "ens18" accept

    # Tránsito WireGuard <-> LAN
    iifname "wg0"  oifname "ens19" accept
    iifname "ens19" oifname "wg0"  accept

    # ICMP LAN -> WAN para diagnóstico
    iifname "ens19" oifname "ens18" ip protocol icmp accept

    # Replicación DC Coruña a DC orense
    tcp dport 49152-65535 ip saddr 10.0.4.21 ip daddr 10.0.2.21 accept
    tcp sport 49152-65535 ip saddr 10.0.2.21 ip daddr 10.0.4.21 accept

  }

  chain output {
    type filter hook output priority filter; policy accept;
  }
}

table ip nat {
  # Redes internas/VPN que no pasan por NAT
  set redes_vpn {
    type ipv4_addr
    flags interval, constant
    elements = { 10.0.2.0/24, 10.0.3.0/24, 10.0.4.0/24, 10.0.5.0/24, 10.99.0.0/30 }
  }

  chain prerouting {
    type nat hook prerouting priority dstnat; policy accept;
    # (sin DNAT público en Ourense)
  }

  chain postrouting {
    type nat hook postrouting priority srcnat; policy accept;

    # No NAT a redes internas/VPN
    ip daddr @redes_vpn return

    # NAT solo a Internet por WAN
    oifname "ens18" masquerade
  }
}
